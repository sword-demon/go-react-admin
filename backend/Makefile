# Go-React-Admin Backend Makefile
# é¡¹ç›®æ ¹ç›®å½•: backend/

.PHONY: help dev build run test fmt vet lint clean tidy migrate

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¡¹ç›®å˜é‡
BINARY_NAME=server
MAIN_PATH=./cmd/server/main.go
BUILD_DIR=./bin
CONFIG_PATH=./configs/config.yml

# Go å‘½ä»¤
GOCMD=go
GOBUILD=$(GOCMD) build
GOCLEAN=$(GOCMD) clean
GOTEST=$(GOCMD) test
GOGET=$(GOCMD) get
GOMOD=$(GOCMD) mod
GOFMT=$(GOCMD) fmt
GOVET=$(GOCMD) vet

## help: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "Go-React-Admin Backend - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "  make dev          - å¯åŠ¨å¼€å‘æœåŠ¡å™¨(çƒ­é‡è½½,éœ€è¦ air)"
	@echo "  make run          - ç›´æ¥è¿è¡ŒæœåŠ¡å™¨"
	@echo "  make build        - ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶åˆ° bin/ ç›®å½•"
	@echo "  make test         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make fmt          - æ ¼å¼åŒ–ä»£ç (go fmt)"
	@echo "  make vet          - ä»£ç æ£€æŸ¥(go vet)"
	@echo "  make lint         - ä»£ç é™æ€åˆ†æ(éœ€è¦ staticcheck)"
	@echo "  make tidy         - æ•´ç†ä¾èµ–(go mod tidy)"
	@echo "  make clean        - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make migrate      - è¿è¡Œæ•°æ®åº“è¿ç§»"
	@echo "  make check        - è¿è¡Œæ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥(fmt+vet+test)"
	@echo ""

## dev: å¯åŠ¨å¼€å‘æœåŠ¡å™¨(çƒ­é‡è½½)
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨(çƒ­é‡è½½)..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "âŒ æœªæ‰¾åˆ° air å·¥å…·,è¯·å…ˆå®‰è£…:"; \
		echo "   go install github.com/air-verse/air@latest"; \
		exit 1; \
	fi

## run: ç›´æ¥è¿è¡ŒæœåŠ¡å™¨
run:
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡å™¨..."
	@if [ ! -f $(CONFIG_PATH) ]; then \
		echo "âš ï¸  é…ç½®æ–‡ä»¶ä¸å­˜åœ¨,æ­£åœ¨å¤åˆ¶ç¤ºä¾‹é…ç½®..."; \
		cp configs/config.example.yml $(CONFIG_PATH); \
		echo "âœ… å·²åˆ›å»º $(CONFIG_PATH),è¯·ä¿®æ”¹æ•°æ®åº“é…ç½®"; \
	fi
	$(GOCMD) run $(MAIN_PATH)

## build: ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶
build:
	@echo "ğŸ”¨ ç¼–è¯‘é¡¹ç›®..."
	@mkdir -p $(BUILD_DIR)
	$(GOBUILD) -o $(BUILD_DIR)/$(BINARY_NAME) -v $(MAIN_PATH)
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(BUILD_DIR)/$(BINARY_NAME)"

## test: è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	$(GOTEST) -v -cover ./...

## test-verbose: è¿è¡Œè¯¦ç»†æµ‹è¯•
test-verbose:
	@echo "ğŸ§ª è¿è¡Œè¯¦ç»†æµ‹è¯•..."
	$(GOTEST) -v -coverprofile=coverage.out ./...
	$(GOCMD) tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Š: coverage.html"

## fmt: æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	$(GOFMT) ./...
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

## vet: ä»£ç æ£€æŸ¥
vet:
	@echo "ğŸ” è¿è¡Œ go vet..."
	$(GOVET) ./...
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

## lint: é™æ€åˆ†æ(éœ€è¦ staticcheck)
lint:
	@echo "ğŸ” è¿è¡Œé™æ€åˆ†æ..."
	@if command -v staticcheck > /dev/null; then \
		staticcheck ./...; \
		echo "âœ… é™æ€åˆ†æå®Œæˆ"; \
	else \
		echo "âš ï¸  æœªæ‰¾åˆ° staticcheck,è·³è¿‡é™æ€åˆ†æ"; \
		echo "   å®‰è£…: go install honnef.co/go/tools/cmd/staticcheck@latest"; \
	fi

## tidy: æ•´ç†ä¾èµ–
tidy:
	@echo "ğŸ“¦ æ•´ç†ä¾èµ–..."
	$(GOMOD) tidy
	@echo "âœ… ä¾èµ–æ•´ç†å®Œæˆ"

## clean: æ¸…ç†ç¼–è¯‘æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	$(GOCLEAN)
	rm -rf $(BUILD_DIR)
	rm -f coverage.out coverage.html
	@echo "âœ… æ¸…ç†å®Œæˆ"

## check: è¿è¡Œæ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥
check: fmt vet test
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡!"

## migrate: è¿è¡Œæ•°æ®åº“è¿ç§»(éœ€è¦å…ˆå¯åŠ¨MySQL)
migrate:
	@echo "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
	@if [ -f ../docs/schema.sql ]; then \
		mysql -u root -p go_react_admin < ../docs/schema.sql; \
		echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"; \
	else \
		echo "âŒ æœªæ‰¾åˆ° schema.sql æ–‡ä»¶"; \
		exit 1; \
	fi

## install-tools: å®‰è£…å¼€å‘å·¥å…·
install-tools:
	@echo "ğŸ“¦ å®‰è£…å¼€å‘å·¥å…·..."
	go install github.com/air-verse/air@latest
	go install honnef.co/go/tools/cmd/staticcheck@latest
	@echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆ"

## deps: å®‰è£…é¡¹ç›®ä¾èµ–
deps:
	@echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
	$(GOMOD) download
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

## docker-up: å¯åŠ¨ Docker ç¯å¢ƒ(MySQL + Redis)
docker-up:
	@echo "ğŸ³ å¯åŠ¨ Docker ç¯å¢ƒ..."
	@if command -v docker-compose > /dev/null; then \
		docker-compose up -d; \
		echo "âœ… Docker ç¯å¢ƒå·²å¯åŠ¨"; \
	else \
		echo "âŒ æœªæ‰¾åˆ° docker-compose"; \
	fi

## docker-down: åœæ­¢ Docker ç¯å¢ƒ
docker-down:
	@echo "ğŸ³ åœæ­¢ Docker ç¯å¢ƒ..."
	@if command -v docker-compose > /dev/null; then \
		docker-compose down; \
		echo "âœ… Docker ç¯å¢ƒå·²åœæ­¢"; \
	else \
		echo "âŒ æœªæ‰¾åˆ° docker-compose"; \
	fi

## db-backup: å¤‡ä»½æ•°æ®åº“
db-backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
	@mkdir -p ./backups
	mysqldump -u root -p go_react_admin > ./backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ"

## db-restore: æ¢å¤æ•°æ®åº“(éœ€è¦æä¾› FILE å‚æ•°)
db-restore:
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ è¯·æä¾›å¤‡ä»½æ–‡ä»¶: make db-restore FILE=backups/backup.sql"; \
		exit 1; \
	fi
	@echo "ğŸ’¾ æ¢å¤æ•°æ®åº“ä» $(FILE)..."
	mysql -u root -p go_react_admin < $(FILE)
	@echo "âœ… æ•°æ®åº“æ¢å¤å®Œæˆ"

## info: æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo "ğŸ“Š é¡¹ç›®ä¿¡æ¯:"
	@echo "  Go ç‰ˆæœ¬:      $$(go version)"
	@echo "  é¡¹ç›®è·¯å¾„:     $$(pwd)"
	@echo "  äºŒè¿›åˆ¶åç§°:   $(BINARY_NAME)"
	@echo "  é…ç½®æ–‡ä»¶:     $(CONFIG_PATH)"
	@echo ""
	@echo "ğŸ“¦ ä¾èµ–ç»Ÿè®¡:"
	@$(GOMOD) graph | wc -l | xargs echo "  ä¾èµ–åŒ…æ•°é‡: "
	@echo ""
	@echo "ğŸ“ˆ ä»£ç ç»Ÿè®¡:"
	@find . -name "*.go" -not -path "./vendor/*" | xargs wc -l | tail -1